# Render Blueprint for Microservices Architecture
# This file automates the deployment of all services
# Place this file at: /backend/microservices/render.yaml

services:
  # ============================================
  # AUTH SERVICE
  # ============================================
  - type: web
    name: auth-service
    env: docker
    region: oregon
    plan: starter
    rootDir: auth-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: DATABASE_URL
        fromDatabase:
          name: evently-postgres
          property: connectionString
      - key: REDIS_URL
        sync: false  # Add manually or from Redis service
      - key: JWT_SECRET
        generateValue: true
        length: 64
      - key: ENCRYPTION_KEY
        generateValue: true
        length: 64
      - key: EMAIL_USER
        sync: false  # Add manually
      - key: EMAIL_PASS
        sync: false  # Add manually
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

  # ============================================
  # USER SERVICE
  # ============================================
  - type: web
    name: user-service
    env: docker
    region: oregon
    plan: starter
    rootDir: user-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3002
      - key: DATABASE_URL
        fromDatabase:
          name: evently-postgres
          property: connectionString
      - key: REDIS_URL
        sync: false
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

  # ============================================
  # EVENT SERVICE
  # ============================================
  - type: web
    name: event-service
    env: docker
    region: oregon
    plan: starter
    rootDir: event-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3003
      - key: DATABASE_URL
        fromDatabase:
          name: evently-postgres
          property: connectionString
      - key: REDIS_URL
        sync: false
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

  # ============================================
  # TRANSACTION SERVICE
  # ============================================
  - type: web
    name: transaction-service
    env: docker
    region: oregon
    plan: starter
    rootDir: transaction-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3004
      - key: DATABASE_URL
        fromDatabase:
          name: evently-postgres
          property: connectionString
      - key: REDIS_URL
        sync: false
      - key: RAZORPAY_KEY_ID
        sync: false  # Add manually
      - key: RAZORPAY_KEY_SECRET
        sync: false  # Add manually
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

  # ============================================
  # ADMIN SERVICE
  # ============================================
  - type: web
    name: admin-service
    env: docker
    region: oregon
    plan: starter
    rootDir: admin-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3005
      - key: DATABASE_URL
        fromDatabase:
          name: evently-postgres
          property: connectionString
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

  # ============================================
  # UPLOAD SERVICE
  # ============================================
  - type: web
    name: upload-service
    env: docker
    region: oregon
    plan: starter
    rootDir: upload-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3006
      - key: R2_BUCKET
        sync: false  # Add manually
      - key: R2_ENDPOINT
        sync: false  # Add manually
      - key: R2_ACCESS_KEY_ID
        sync: false  # Add manually
      - key: R2_SECRET_ACCESS_KEY
        sync: false  # Add manually
      - key: R2_PUBLIC_URL
        sync: false  # Add manually
      - key: CLIENT_URL
        value: https://your-frontend.onrender.com  # Update this

# ============================================
# SHARED DATABASE
# ============================================
databases:
  - name: evently-postgres
    databaseName: evently_db
    user: admin
    region: oregon
    plan: starter  # $7/month, or 'free' for 90-day trial
    ipAllowList: []  # Allow all IPs (or specify)

# ============================================
# NOTES:
# ============================================
# 1. Update CLIENT_URL values after deploying frontend
# 2. Add manual environment variables marked with "sync: false"
# 3. For Redis, either:
#    - Use Upstash (free): https://upstash.com/
#    - Add Render Redis service here (costs $7/month)
# 4. Deployment order:
#    - Database creates first
#    - Then all 6 services deploy in parallel
# 5. Frontend must call each service directly:
#    - Auth: https://auth-service.onrender.com/api/v1/*
#    - User: https://user-service.onrender.com/api/v1/*
#    - Event: https://event-service.onrender.com/api/v1/*
#    - Transaction: https://transaction-service.onrender.com/api/v1/*
#    - Admin: https://admin-service.onrender.com/api/v1/*
#    - Upload: https://upload-service.onrender.com/api/v1/*
# 6. Total cost: $42/month (6 services Ã— $7) + $7/month database = $49/month
# 7. To deploy: Push this file to your repo, Render auto-detects it

